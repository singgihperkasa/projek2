<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Digital Lengkap - 114 Surah</title>
    <style>
        /* CSS tetap sama seperti sebelumnya */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a5e1a, #0d3315);
            color: #333;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* ... (CSS lainnya tetap sama) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quran Digital Lengkap</h1>
            <p>114 Surah - 6236 Ayat Lengkap</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Pilih Qari:</label>
                <select id="qariSelect">
                    <option value="ar.alafasy">Mishary Alafasy</option>
                    <option value="ar.abdurrahmaansudais">Abdurrahman As-Sudais</option>
                    <option value="ar.abdulbasitmurattal">Abdul Basit Murattal</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Pilih Surah:</label>
                <select id="surahSelect">
                    <!-- Akan diisi oleh JavaScript -->
                </select>
            </div>
            
            <div class="control-group">
                <label>Kontrol Playback:</label>
                <div class="playback-controls">
                    <button id="playBtn">▶ Mulai Auto-Play</button>
                    <button id="pauseBtn" disabled>⏸ Jeda</button>
                    <button id="stopBtn" disabled>⏹ Stop</button>
                    <button id="nextBtn" disabled>⏭ Lanjut</button>
                </div>
            </div>

            <div class="control-group">
                <label>Pengaturan:</label>
                <div class="playback-controls">
                    <button id="autoNextBtn" class="active">Auto Next: ON</button>
                    <button id="voiceSpeedBtn">Kecepatan: Normal</button>
                </div>
            </div>
        </div>
        
        <div class="status" id="statusText">
            Memuat data Quran...
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
        
        <div class="quran-text" id="quranText">
            <div class="loading">Memuat data Quran lengkap...</div>
        </div>
        
        <div class="footer">
            <p>Quran Digital &copy; 2024 • 114 Surah Lengkap</p>
        </div>
    </div>

    <script>
        // ==================== KONFIGURASI ====================
        const API_CONFIG = {
            quranApi: {
                audioBaseUrl: "https://cdn.islamic.network/quran/audio/128"
            }
        };

        // ==================== STATE MANAGEMENT ====================
        const state = {
            currentSurah: null,
            currentVerses: [],
            currentVerseIndex: 0,
            currentQari: 'ar.alafasy',
            isPlaying: false,
            isPaused: false,
            autoNext: true,
            isPlayingQari: false,
            voiceSpeed: 1.0,
            audioElement: null,
            synthesis: window.speechSynthesis || null,
            allSurahs: [],
            quranData: []
        };

        // ==================== CACHE DOM ELEMENTS ====================
        const elements = {
            qariSelect: document.getElementById('qariSelect'),
            surahSelect: document.getElementById('surahSelect'),
            playBtn: document.getElementById('playBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            stopBtn: document.getElementById('stopBtn'),
            nextBtn: document.getElementById('nextBtn'),
            autoNextBtn: document.getElementById('autoNextBtn'),
            voiceSpeedBtn: document.getElementById('voiceSpeedBtn'),
            statusText: document.getElementById('statusText'),
            quranText: document.getElementById('quranText'),
            progressBar: document.getElementById('progressBar')
        };

        // ==================== LOAD QURAN DATA ====================
        async function loadQuranData() {
            try {
                elements.statusText.textContent = "Memuat data Quran lengkap...";
                
                // Load data dari file JSON lokal
                const response = await fetch('data/quran-data.json');
                if (!response.ok) {
                    throw new Error('File data Quran tidak ditemukan');
                }
                
                state.quranData = await response.json();
                initializeApp();
                
            } catch (error) {
                console.error('Error loading Quran data:', error);
                elements.statusText.textContent = "Error memuat data. Menggunakan data offline...";
                // Fallback ke data offline minimal
                loadFallbackData();
            }
        }

        function loadFallbackData() {
            // Data minimal untuk demo jika file JSON tidak ada
            state.quranData = [
                {
                    number: 1,
                    name: "Al-Fatihah",
                    arabic: "الفاتحة",
                    verses: 7,
                    verses: [
                        { number: 1, arabic: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", translation: "Dengan nama Allah Yang Maha Pengasih, Maha Penyayang." },
                        { number: 2, arabic: "الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ", translation: "Segala puji bagi Allah, Tuhan seluruh alam," },
                        { number: 3, arabic: "الرَّحْمَٰنِ الرَّحِيمِ", translation: "Yang Maha Pengasih, Maha Penyayang," },
                        { number: 4, arabic: "مَالِكِ يَوْمِ الدِّينِ", translation: "Pemilik hari pembalasan." },
                        { number: 5, arabic: "إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ", translation: "Hanya kepada Engkaulah kami menyembah dan hanya kepada Engkaulah kami mohon pertolongan." },
                        { number: 6, arabic: "اهْدِنَا الصِّرَاطَ الْمُسْتَقِيمَ", translation: "Tunjukilah kami jalan yang lurus," },
                        { number: 7, arabic: "صِرَاطَ الَّذِينَ أَنْعَمْتَ عَلَيْهِمْ غَيْرِ الْمَغْضُوبِ عَلَيْهِمْ وَلَا الضَّالِّينَ", translation: "(yaitu) jalan orang-orang yang telah Engkau beri nikmat kepadanya; bukan (jalan) mereka yang dimurkai, dan bukan (pula jalan) mereka yang sesat." }
                    ]
                },
                {
                    number: 114,
                    name: "An-Nas", 
                    arabic: "الناس",
                    verses: 6,
                    verses: [
                        { number: 1, arabic: "قُلْ أَعُوذُ بِرَبِّ النَّاسِ", translation: "Katakanlah, Aku berlindung kepada Tuhan manusia," },
                        { number: 2, arabic: "مَلِكِ النَّاسِ", translation: "Raja manusia," },
                        { number: 3, arabic: "إِلَٰهِ النَّاسِ", translation: "Sembahan manusia," },
                        { number: 4, arabic: "مِنْ شَرِّ الْوَسْوَاسِ الْخَنَّاسِ", translation: "dari kejahatan (bisikan) setan yang bersembunyi," },
                        { number: 5, arabic: "الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ", translation: "yang membisikkan (kejahatan) ke dalam dada manusia," },
                        { number: 6, arabic: "مِنَ الْجِنَّةِ وَالنَّاسِ", translation: "dari (golongan) jin dan manusia." }
                    ]
                }
            ];
            initializeApp();
        }

        function initializeApp() {
            initializeSurahDropdown();
            loadSurah(1); // Load surah pertama
            elements.statusText.textContent = `Data Quran dimuat. ${state.quranData.length} surah tersedia.`;
        }

        function initializeSurahDropdown() {
            elements.surahSelect.innerHTML = '';
            state.quranData.forEach(surah => {
                const option = document.createElement('option');
                option.value = surah.number;
                option.textContent = `${surah.number}. ${surah.name} (${surah.arabic}) - ${surah.verses.length} ayat`;
                elements.surahSelect.appendChild(option);
            });
        }

        function loadSurah(surahNumber) {
            const surah = state.quranData.find(s => s.number === surahNumber);
            if (!surah) {
                elements.statusText.textContent = `Surah ${surahNumber} tidak ditemukan`;
                return;
            }

            state.currentSurah = surah;
            state.currentVerses = surah.verses;
            state.currentVerseIndex = 0;
            state.isPlayingQari = true;

            renderVerses();
            resetPlayback();
            
            elements.statusText.textContent = `Surah ${surah.name} dimuat. ${surah.verses.length} ayat tersedia.`;
        }

        // ==================== PLAYBACK SYSTEM ====================
        // [Fungsi playback sama seperti sebelumnya]
        function playCurrent() {
            if (!state.currentVerses.length || state.currentVerseIndex >= state.currentVerses.length) {
                stopPlayback();
                return;
            }
            
            const verse = state.currentVerses[state.currentVerseIndex];
            
            updateVerseHighlight();
            updateProgress();
            
            if (state.isPlayingQari) {
                playQariAudio(verse);
            } else {
                playTranslationTTS(verse);
            }
        }

        function playQariAudio(verse) {
            elements.statusText.textContent = `Memutar ayat ${verse.number} - ${state.currentSurah.name}`;

            const audioUrl = `${API_CONFIG.quranApi.audioBaseUrl}/${state.currentQari}/${state.currentSurah.number}${verse.number.toString().padStart(3, '0')}.mp3`;
            
            if (state.audioElement) {
                state.audioElement.pause();
                state.audioElement = null;
            }
            
            state.audioElement = new Audio(audioUrl);
            state.audioElement.preload = 'auto';
            
            state.audioElement.oncanplaythrough = () => {
                state.audioElement.play().catch(e => {
                    console.error('Error playing audio:', e);
                    elements.statusText.textContent = 'Error memutar audio. Lanjut ke terjemahan...';
                    state.isPlayingQari = false;
                    setTimeout(() => playNextSegment(), 1000);
                });
            };
            
            state.audioElement.onplay = () => {
                state.isPlaying = true;
                updateControls();
            };
            
            state.audioElement.ontimeupdate = updateProgress;
            
            state.audioElement.onended = () => {
                state.isPlayingQari = false;
                if (state.autoNext) {
                    playNextSegment();
                }
            };
            
            state.audioElement.onerror = (e) => {
                console.error('Audio error:', e);
                elements.statusText.textContent = 'Error memutar audio. Lanjut ke terjemahan...';
                state.isPlayingQari = false;
                setTimeout(() => playNextSegment(), 1000);
            };
        }

        function playTranslationTTS(verse) {
            elements.statusText.textContent = `Memutar terjemahan ayat ${verse.number} - ${state.currentSurah.name}`;

            if (!state.synthesis) {
                elements.statusText.textContent = 'TTS tidak didukung. Lanjut ke ayat berikutnya.';
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                playNextSegment();
                return;
            }

            state.synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(verse.translation);
            utterance.lang = 'id-ID';
            utterance.rate = state.voiceSpeed;
            utterance.pitch = 1.0;

            const voices = state.synthesis.getVoices();
            const indonesianVoice = voices.find(voice => voice.lang.includes('id'));
            if (indonesianVoice) utterance.voice = indonesianVoice;

            utterance.onstart = () => {
                const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
                if (currentVerse) currentVerse.classList.add('playing-translation');
            };

            utterance.onend = () => {
                const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
                if (currentVerse) currentVerse.classList.remove('playing-translation');
                
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                if (state.autoNext) playNextSegment();
            };

            utterance.onerror = (event) => {
                console.error('TTS Error:', event);
                const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
                if (currentVerse) currentVerse.classList.remove('playing-translation');
                
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                if (state.autoNext) playNextSegment();
            };

            state.synthesis.speak(utterance);
        }

        function playNextSegment() {
            if (state.currentVerseIndex < state.currentVerses.length) {
                playCurrent();
            } else {
                elements.statusText.textContent = `Selesai memutar ${state.currentSurah.name}`;
                stopPlayback();
            }
        }

        function updateProgress() {
            if (state.audioElement && state.audioElement.duration && state.isPlayingQari) {
                const progress = (state.audioElement.currentTime / state.audioElement.duration) * 100;
                elements.progressBar.style.width = `${progress}%`;
            } else {
                elements.progressBar.style.width = '0%';
            }
        }

        function updateVerseHighlight() {
            document.querySelectorAll('.verse').forEach(verse => {
                verse.classList.remove('active', 'playing-translation');
            });
            
            const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
            if (currentVerse) {
                if (state.isPlayingQari) {
                    currentVerse.classList.add('active');
                } else {
                    currentVerse.classList.add('playing-translation');
                }
            }
        }

        function renderVerses() {
            if (!state.currentVerses.length) {
                elements.quranText.innerHTML = '<div class="loading">Tidak ada data ayat</div>';
                return;
            }

            const versesHTML = state.currentVerses.map((verse, index) => `
                <div class="verse" id="verse-${index}">
                    <div class="arabic">${verse.arabic} <span class="verse-number">${verse.number}</span></div>
                    <div class="translation">${verse.translation}</div>
                </div>
            `).join('');
            
            elements.quranText.innerHTML = versesHTML;
        }

        function startPlayback() {
            if (!state.currentVerses.length) {
                elements.statusText.textContent = "Tidak ada data ayat yang dimuat";
                return;
            }
            
            resetPlayback();
            state.isPlaying = true;
            state.isPaused = false;
            state.isPlayingQari = true;
            state.currentVerseIndex = 0;
            updateControls();
            playCurrent();
        }

        function pausePlayback() {
            if (state.isPlayingQari && state.audioElement && !state.audioElement.paused) {
                state.audioElement.pause();
            } else if (!state.isPlayingQari && state.synthesis && state.synthesis.speaking) {
                state.synthesis.pause();
            }
            state.isPaused = true;
            updateControls();
            elements.statusText.textContent = "Dijeda";
        }

        function resumePlayback() {
            if (state.isPlayingQari && state.audioElement && state.audioElement.paused) {
                state.audioElement.play();
            } else if (!state.isPlayingQari && state.synthesis && state.synthesis.paused) {
                state.synthesis.resume();
            }
            state.isPaused = false;
            updateControls();
            elements.statusText.textContent = `Melanjutkan ${state.isPlayingQari ? 'Qari' : 'Terjemahan'} ayat ${state.currentVerseIndex + 1}`;
        }

        function stopPlayback() {
            if (state.audioElement) {
                state.audioElement.pause();
                state.audioElement = null;
            }
            if (state.synthesis) {
                state.synthesis.cancel();
            }
            
            state.isPlaying = false;
            state.isPaused = false;
            state.isPlayingQari = true;
            updateControls();
            
            document.querySelectorAll('.verse').forEach(verse => {
                verse.classList.remove('active', 'playing-translation');
            });
            
            elements.progressBar.style.width = '0%';
            elements.statusText.textContent = "Playback dihentikan";
        }

        function resetPlayback() {
            stopPlayback();
            state.currentVerseIndex = 0;
            state.isPlayingQari = true;
        }

        function skipToNext() {
            if (state.isPlaying) {
                if (state.isPlayingQari && state.audioElement) {
                    state.audioElement.pause();
                } else if (!state.isPlayingQari && state.synthesis) {
                    state.synthesis.cancel();
                }
                
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                playNextSegment();
            }
        }

        function updateControls() {
            const hasData = state.currentVerses.length > 0;
            
            elements.playBtn.disabled = !hasData || (state.isPlaying && !state.isPaused);
            elements.pauseBtn.disabled = !hasData || !state.isPlaying || state.isPaused;
            elements.stopBtn.disabled = !hasData || !state.isPlaying;
            elements.nextBtn.disabled = !hasData || !state.isPlaying || state.currentVerseIndex >= state.currentVerses.length - 1;
            
            elements.playBtn.textContent = state.isPaused ? "▶ Lanjutkan" : "▶ Mulai Auto-Play";
        }

        // ==================== EVENT HANDLERS ====================
        elements.surahSelect.addEventListener('change', (e) => {
            loadSurah(parseInt(e.target.value));
        });

        elements.qariSelect.addEventListener('change', (e) => {
            state.currentQari = e.target.value;
        });

        elements.playBtn.addEventListener('click', () => {
            if (state.isPaused) {
                resumePlayback();
            } else {
                startPlayback();
            }
        });

        elements.pauseBtn.addEventListener('click', pausePlayback);
        elements.stopBtn.addEventListener('click', stopPlayback);
        elements.nextBtn.addEventListener('click', skipToNext);
        
        elements.autoNextBtn.addEventListener('click', () => {
            state.autoNext = !state.autoNext;
            elements.autoNextBtn.textContent = `Auto Next: ${state.autoNext ? 'ON' : 'OFF'}`;
            elements.autoNextBtn.classList.toggle('active', state.autoNext);
        });

        elements.voiceSpeedBtn.addEventListener('click', () => {
            const speeds = [0.8, 1.0, 1.2, 1.5];
            const currentIndex = speeds.indexOf(state.voiceSpeed);
            const nextIndex = (currentIndex + 1) % speeds.length;
            state.voiceSpeed = speeds[nextIndex];
            
            const labels = ['Lambat', 'Normal', 'Cepat', 'Sangat Cepat'];
            elements.voiceSpeedBtn.textContent = `Kecepatan: ${labels[nextIndex]}`;
        });

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', () => {
            if (state.synthesis) {
                state.synthesis.onvoiceschanged = () => {
                    console.log('Voices loaded:', state.synthesis.getVoices());
                };
            }
            loadQuranData();
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && state.isPlaying && !state.isPaused) {
                pausePlayback();
            }
        });
    </script>
</body>
</html>