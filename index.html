<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Digital Lengkap</title>
    <style>
        /* CSS sama seperti sebelumnya */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a5e1a, #0d3315); color: #333; min-height: 100vh; padding: 15px; }
        .container { max-width: 1000px; margin: 0 auto; background: rgba(255,255,255,0.98); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2d7d2d, #1a5e1a); color: white; padding: 20px; text-align: center; }
        .controls { background: #e8f5e8; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; border-bottom: 2px solid #2d7d2d; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-weight: 600; color: #1a5e1a; font-size: 0.9em; }
        select, button { padding: 10px 12px; border: none; border-radius: 6px; font-size: 0.95em; cursor: pointer; transition: all 0.2s ease; }
        select { background: white; border: 2px solid #2d7d2d; }
        button { background: #2d7d2d; color: white; font-weight: 600; }
        button:hover { background: #1a5e1a; transform: translateY(-1px); }
        button:disabled { background: #cccccc; cursor: not-allowed; transform: none; }
        .playback-controls { display: flex; gap: 8px; flex-wrap: wrap; }
        .status { background: #f8fff8; padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #2d7d2d; font-size: 0.9em; }
        .quran-text { padding: 20px; direction: rtl; max-height: 60vh; overflow-y: auto; }
        .verse { margin-bottom: 20px; padding: 15px; border-radius: 12px; background: #f8fff8; border: 2px solid transparent; transition: all 0.2s ease; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .verse.active { border-color: #2d7d2d; background: #e8f5e8; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(45,125,45,0.15); }
        .verse.playing-translation { border-color: #ff6b00; background: #fff8f0; }
        .arabic { font-size: 1.8em; line-height: 1.6; text-align: center; color: #1a3a1a; margin-bottom: 10px; font-family: 'Traditional Arabic', 'Scheherazade', serif; }
        .translation { font-size: 1em; line-height: 1.5; text-align: center; color: #444; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #2d7d2d; }
        .verse-number { display: inline-block; background: #2d7d2d; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-size: 0.8em; margin-left: 6px; }
        .footer { text-align: center; padding: 15px; background: #1a5e1a; color: white; font-size: 0.85em; }
        .loading { text-align: center; padding: 20px; color: #2d7d2d; }
        .progress-bar { width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .progress { height: 100%; background: #2d7d2d; width: 0%; transition: width 0.3s ease; }
        @media (max-width: 768px) { .controls { grid-template-columns: 1fr; } .arabic { font-size: 1.5em; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quran Digital Lengkap</h1>
            <p>114 Surah - CDN Data</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Pilih Qari:</label>
                <select id="qariSelect">
                    <option value="ar.alafasy">Mishary Alafasy</option>
                    <option value="ar.abdurrahmaansudais">Abdurrahman As-Sudais</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Pilih Surah:</label>
                <select id="surahSelect">
                    <!-- Diisi JavaScript -->
                </select>
            </div>
            
            <div class="control-group">
                <label>Kontrol:</label>
                <div class="playback-controls">
                    <button id="playBtn">▶ Mulai Auto-Play</button>
                    <button id="pauseBtn" disabled>⏸ Jeda</button>
                    <button id="stopBtn" disabled>⏹ Stop</button>
                </div>
            </div>
        </div>
        
        <div class="status" id="statusText">Memuat...</div>
        <div class="progress-bar"><div class="progress" id="progressBar"></div></div>
        <div class="quran-text" id="quranText"><div class="loading">Memuat Quran...</div></div>
        <div class="footer"><p>Quran Digital &copy; 2024</p></div>
    </div>

    <script>
        // ✅ SOLUSI SIMPLE: Gunakan CDN
        const QURAN_CDN_URL = "https://cdn.jsdelivr.net/npm/quran-json@3.1.2/dist/quran.json";
        
        const state = {
            currentSurah: null, currentVerses: [], currentVerseIndex: 0,
            currentQari: 'ar.alafasy', isPlaying: false, isPaused: false,
            audioElement: null, synthesis: window.speechSynthesis
        };

        const elements = {
            qariSelect: document.getElementById('qariSelect'),
            surahSelect: document.getElementById('surahSelect'),
            playBtn: document.getElementById('playBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            stopBtn: document.getElementById('stopBtn'),
            statusText: document.getElementById('statusText'),
            quranText: document.getElementById('quranText'),
            progressBar: document.getElementById('progressBar')
        };

        // ✅ LOAD DATA DARI CDN
        async function loadQuranData() {
            try {
                elements.statusText.textContent = "Memuat data Quran...";
                const response = await fetch(QURAN_CDN_URL);
                const data = await response.json();
                
                // Format data untuk aplikasi kita
                state.allSurahs = data.map(surah => ({
                    number: surah.chapter,
                    name: surah.name,
                    arabic: surah.arabic,
                    verses: surah.verses.map(verse => ({
                        number: verse.verse,
                        arabic: verse.text,
                        translation: verse.translation?.id || "Terjemahan tidak tersedia"
                    }))
                }));
                
                initializeApp();
                
            } catch (error) {
                elements.statusText.textContent = "Error memuat data. Gunakan data offline.";
                loadOfflineData();
            }
        }

        // ✅ DATA OFFLINE JIKA CDN GAGAL
        function loadOfflineData() {
            state.allSurahs = [
                {
                    number: 1, name: "Al-Fatihah", arabic: "الفاتحة",
                    verses: [
                        {number:1,arabic:"بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ",translation:"Dengan nama Allah Yang Maha Pengasih, Maha Penyayang."},
                        {number:2,arabic:"الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ",translation:"Segala puji bagi Allah, Tuhan seluruh alam,"},
                        {number:3,arabic:"الرَّحْمَٰنِ الرَّحِيمِ",translation:"Yang Maha Pengasih, Maha Penyayang,"},
                        {number:4,arabic:"مَالِكِ يَوْمِ الدِّينِ",translation:"Pemilik hari pembalasan."},
                        {number:5,arabic:"إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ",translation:"Hanya kepada Engkaulah kami menyembah dan hanya kepada Engkaulah kami mohon pertolongan."},
                        {number:6,arabic:"اهْدِنَا الصِّرَاطَ الْمُسْتَقِيمَ",translation:"Tunjukilah kami jalan yang lurus,"},
                        {number:7,arabic:"صِرَاطَ الَّذِينَ أَنْعَمْتَ عَلَيْهِمْ غَيْرِ الْمَغْضُوبِ عَلَيْهِمْ وَلَا الضَّالِّينَ",translation:"(yaitu) jalan orang-orang yang telah Engkau beri nikmat kepadanya; bukan (jalan) mereka yang dimurkai, dan bukan (pula jalan) mereka yang sesat."}
                    ]
                },
                {
                    number: 114, name: "An-Nas", arabic: "الناس",
                    verses: [
                        {number:1,arabic:"قُلْ أَعُوذُ بِرَبِّ النَّاسِ",translation:"Katakanlah, Aku berlindung kepada Tuhan manusia,"},
                        {number:2,arabic:"مَلِكِ النَّاسِ",translation:"Raja manusia,"},
                        {number:3,arabic:"إِلَٰهِ النَّاسِ",translation:"Sembahan manusia,"},
                        {number:4,arabic:"مِنْ شَرِّ الْوَسْوَاسِ الْخَنَّاسِ",translation:"dari kejahatan (bisikan) setan yang bersembunyi,"},
                        {number:5,arabic:"الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ",translation:"yang membisikkan (kejahatan) ke dalam dada manusia,"},
                        {number:6,arabic:"مِنَ الْجِنَّةِ وَالنَّاسِ",translation:"dari (golongan) jin dan manusia."}
                    ]
                }
            ];
            initializeApp();
        }

        function initializeApp() {
            // Isi dropdown surah
            elements.surahSelect.innerHTML = '';
            state.allSurahs.forEach(surah => {
                const option = document.createElement('option');
                option.value = surah.number;
                option.textContent = `${surah.number}. ${surah.name}`;
                elements.surahSelect.appendChild(option);
            });
            
            loadSurah(1);
            elements.statusText.textContent = `Ready! ${state.allSurahs.length} surah tersedia`;
        }

        function loadSurah(surahNumber) {
            const surah = state.allSurahs.find(s => s.number === surahNumber);
            if (!surah) return;
            
            state.currentSurah = surah;
            state.currentVerses = surah.verses;
            state.currentVerseIndex = 0;
            
            renderVerses();
            resetPlayback();
            elements.statusText.textContent = `${surah.name} dimuat - ${surah.verses.length} ayat`;
        }

        function renderVerses() {
            const versesHTML = state.currentVerses.map((verse, index) => `
                <div class="verse" id="verse-${index}">
                    <div class="arabic">${verse.arabic} <span class="verse-number">${verse.number}</span></div>
                    <div class="translation">${verse.translation}</div>
                </div>
            `).join('');
            elements.quranText.innerHTML = versesHTML;
        }

        // ✅ SISTEM PLAYBACK SEDERHANA
        function playCurrent() {
            if (!state.currentVerses.length) return;
            
            const verse = state.currentVerses[state.currentVerseIndex];
            updateVerseHighlight();
            
            if (state.isPlayingQari) {
                // Play audio qari
                const audioUrl = `https://cdn.islamic.network/quran/audio/128/${state.currentQari}/${state.currentSurah.number}${verse.number.toString().padStart(3,'0')}.mp3`;
                
                if (state.audioElement) state.audioElement.pause();
                state.audioElement = new Audio(audioUrl);
                state.audioElement.play();
                
                state.audioElement.onended = () => {
                    state.isPlayingQari = false;
                    playNextSegment();
                };
                
            } else {
                // Play terjemahan TTS
                if (state.synthesis) {
                    const utterance = new SpeechSynthesisUtterance(verse.translation);
                    utterance.lang = 'id-ID';
                    utterance.onend = () => {
                        state.isPlayingQari = true;
                        state.currentVerseIndex++;
                        playNextSegment();
                    };
                    state.synthesis.speak(utterance);
                } else {
                    state.isPlayingQari = true;
                    state.currentVerseIndex++;
                    playNextSegment();
                }
            }
        }

        function playNextSegment() {
            if (state.currentVerseIndex < state.currentVerses.length) {
                playCurrent();
            } else {
                stopPlayback();
                elements.statusText.textContent = `Selesai ${state.currentSurah.name}`;
            }
        }

        function startPlayback() {
            resetPlayback();
            state.isPlaying = true;
            state.isPlayingQari = true;
            state.currentVerseIndex = 0;
            playCurrent();
        }

        function stopPlayback() {
            state.isPlaying = false;
            if (state.audioElement) state.audioElement.pause();
            if (state.synthesis) state.synthesis.cancel();
        }

        function resetPlayback() {
            stopPlayback();
            state.currentVerseIndex = 0;
            state.isPlayingQari = true;
        }

        function updateVerseHighlight() {
            document.querySelectorAll('.verse').forEach(v => v.classList.remove('active','playing-translation'));
            const current = document.getElementById(`verse-${state.currentVerseIndex}`);
            if (current) current.classList.add(state.isPlayingQari ? 'active' : 'playing-translation');
        }

        // ✅ EVENT LISTENERS
        elements.surahSelect.addEventListener('change', (e) => loadSurah(parseInt(e.target.value)));
        elements.qariSelect.addEventListener('change', (e) => state.currentQari = e.target.value);
        elements.playBtn.addEventListener('click', startPlayback);
        elements.stopBtn.addEventListener('click', stopPlayback);
        elements.pauseBtn.addEventListener('click', () => {
            if (state.audioElement) state.audioElement.pause();
            if (state.synthesis) state.synthesis.pause();
        });

        // ✅ START APP
        window.addEventListener('load', loadQuranData);
    </script>
</body>
</html>
