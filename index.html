<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Digital - Ayat & Terjemahan Berselang-seling</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a5e1a, #0d3315);
            color: #333;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d7d2d, #1a5e1a);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .controls {
            background: #e8f5e8;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border-bottom: 2px solid #2d7d2d;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #1a5e1a;
            font-size: 0.9em;
        }

        select, button {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select {
            background: white;
            border: 2px solid #2d7d2d;
        }

        button {
            background: #2d7d2d;
            color: white;
            font-weight: 600;
        }

        button:hover {
            background: #1a5e1a;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .playback-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status {
            background: #f8fff8;
            padding: 12px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
            color: #2d7d2d;
            font-size: 0.9em;
        }

        .quran-text {
            padding: 20px;
            direction: rtl;
            max-height: 60vh;
            overflow-y: auto;
        }

        .verse {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            background: #f8fff8;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .verse.active {
            border-color: #2d7d2d;
            background: #e8f5e8;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(45, 125, 45, 0.15);
        }

        .verse.playing-translation {
            border-color: #ff6b00;
            background: #fff8f0;
        }

        .arabic {
            font-size: 1.8em;
            line-height: 1.6;
            text-align: center;
            color: #1a3a1a;
            margin-bottom: 10px;
            font-family: 'Traditional Arabic', 'Scheherazade', serif;
        }

        .translation {
            font-size: 1em;
            line-height: 1.5;
            text-align: center;
            color: #444;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #2d7d2d;
        }

        .verse-number {
            display: inline-block;
            background: #2d7d2d;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 0.8em;
            margin-left: 6px;
        }

        .audio-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2d7d2d;
            color: white;
        }

        .translation-indicator {
            background: #ff6b00;
        }

        .footer {
            text-align: center;
            padding: 15px;
            background: #1a5e1a;
            color: white;
            font-size: 0.85em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #2d7d2d;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #2d7d2d;
            width: 0%;
            transition: width 0.3s ease;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #ffeaea;
            margin: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quran Digital - Ayat & Terjemahan</h1>
            <p>Selang-seling: Qari → Terjemahan → Qari → Terjemahan</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Pilih Qari:</label>
                <select id="qariSelect">
                    <option value="ar.alafasy">Mishary Alafasy</option>
                    <option value="ar.abdurrahmaansudais">Abdurrahman As-Sudais</option>
                    <option value="ar.abdulbasitmurattal">Abdul Basit Murattal</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Pilih Surah:</label>
                <select id="surahSelect">
                    <option value="1">1. Al-Fatihah</option>
                    <option value="2">2. Al-Baqarah</option>
                    <option value="36">36. Yaasin</option>
                    <option value="55">55. Ar-Rahman</option>
                    <option value="67">67. Al-Mulk</option>
                    <option value="114">114. An-Nas</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Kontrol Playback:</label>
                <div class="playback-controls">
                    <button id="playBtn">▶ Mulai Auto-Play</button>
                    <button id="pauseBtn" disabled>⏸ Jeda</button>
                    <button id="stopBtn" disabled>⏹ Stop</button>
                    <button id="nextBtn" disabled>⏭ Lanjut</button>
                </div>
            </div>

            <div class="control-group">
                <label>Pengaturan:</label>
                <div class="playback-controls">
                    <button id="autoNextBtn" class="active">Auto Next: ON</button>
                    <button id="voiceSpeedBtn">Kecepatan: Normal</button>
                </div>
            </div>
        </div>
        
        <div class="status" id="statusText">
            Pilih surah dan klik "Mulai Auto-Play"
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
        
        <div class="quran-text" id="quranText">
            <div class="loading">Pilih surah untuk memulai...</div>
        </div>
        
        <div class="footer">
            <p>Quran Digital &copy; 2024 • Audio Qari + Terjemahan TTS</p>
        </div>
    </div>

    <script>
        // ==================== KONFIGURASI ====================
        const API_CONFIG = {
            quranApi: {
                baseUrl: "https://api.quran.com/api/v4",
                audioBaseUrl: "https://cdn.islamic.network/quran/audio/128"
            },
            terjemahanApi: {
                baseUrl: "https://quran-api.id"
            }
        };

        // ==================== STATE MANAGEMENT ====================
        const state = {
            currentSurah: null,
            currentVerses: [],
            currentVerseIndex: 0,
            currentQari: 'ar.alafasy',
            isPlaying: false,
            isPaused: false,
            autoNext: true,
            isPlayingQari: false, // true = sedang play qari, false = sedang play terjemahan
            voiceSpeed: 1.0,
            audioElement: null,
            synthesis: window.speechSynthesis || null
        };

        // ==================== CACHE DOM ELEMENTS ====================
        const elements = {
            qariSelect: document.getElementById('qariSelect'),
            surahSelect: document.getElementById('surahSelect'),
            playBtn: document.getElementById('playBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            stopBtn: document.getElementById('stopBtn'),
            nextBtn: document.getElementById('nextBtn'),
            autoNextBtn: document.getElementById('autoNextBtn'),
            voiceSpeedBtn: document.getElementById('voiceSpeedBtn'),
            statusText: document.getElementById('statusText'),
            quranText: document.getElementById('quranText'),
            progressBar: document.getElementById('progressBar')
        };

        // ==================== DATA OFFLINE UNTUK DEMO ====================
        const offlineData = {
            1: [ // Al-Fatihah
                { number: 1, arabic: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", translation: "Dengan nama Allah Yang Maha Pengasih, Maha Penyayang." },
                { number: 2, arabic: "الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ", translation: "Segala puji bagi Allah, Tuhan seluruh alam," },
                { number: 3, arabic: "الرَّحْمَٰنِ الرَّحِيمِ", translation: "Yang Maha Pengasih, Maha Penyayang," },
                { number: 4, arabic: "مَالِكِ يَوْمِ الدِّينِ", translation: "Pemilik hari pembalasan." },
                { number: 5, arabic: "إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ", translation: "Hanya kepada Engkaulah kami menyembah dan hanya kepada Engkaulah kami mohon pertolongan." },
                { number: 6, arabic: "اهْدِنَا الصِّرَاطَ الْمُسْتَقِيمَ", translation: "Tunjukilah kami jalan yang lurus," },
                { number: 7, arabic: "صِرَاطَ الَّذِينَ أَنْعَمْتَ عَلَيْهِمْ غَيْرِ الْمَغْضُوبِ عَلَيْهِمْ وَلَا الضَّالِّينَ", translation: "(yaitu) jalan orang-orang yang telah Engkau beri nikmat kepadanya; bukan (jalan) mereka yang dimurkai, dan bukan (pula jalan) mereka yang sesat." }
            ],
            114: [ // An-Nas
                { number: 1, arabic: "قُلْ أَعُوذُ بِرَبِّ النَّاسِ", translation: "Katakanlah, Aku berlindung kepada Tuhan manusia," },
                { number: 2, arabic: "مَلِكِ النَّاسِ", translation: "Raja manusia," },
                { number: 3, arabic: "إِلَٰهِ النَّاسِ", translation: "Sembahan manusia," },
                { number: 4, arabic: "مِنْ شَرِّ الْوَسْوَاسِ الْخَنَّاسِ", translation: "dari kejahatan (bisikan) setan yang bersembunyi," },
                { number: 5, arabic: "الَّذِي يُوَسْوِسُ فِي صُدورِ النَّاسِ", translation: "yang membisikkan (kejahatan) ke dalam dada manusia," },
                { number: 6, arabic: "مِنَ الْجِنَّةِ وَالنَّاسِ", translation: "dari (golongan) jin dan manusia." }
            ]
        };

        const surahData = {
            1: { name: "Al-Fatihah", arabic: "الفاتحة", verses: 7 },
            2: { name: "Al-Baqarah", arabic: "البقرة", verses: 286 },
            36: { name: "Yaasin", arabic: "يس", verses: 83 },
            55: { name: "Ar-Rahman", arabic: "الرحمن", verses: 78 },
            67: { name: "Al-Mulk", arabic: "الملك", verses: 30 },
            114: { name: "An-Nas", arabic: "الناس", verses: 6 }
        };

        // ==================== SISTEM PLAYBACK BARU ====================
        // Sistem: Qari → Terjemahan → Qari → Terjemahan → ...

        async function loadSurah(surahNumber) {
            try {
                const surah = surahData[surahNumber];
                if (!surah) {
                    throw new Error(`Surah ${surahNumber} tidak ditemukan`);
                }

                // Gunakan data offline untuk demo
                const verses = offlineData[surahNumber] || [];
                
                state.currentSurah = surah;
                state.currentVerses = verses;
                state.currentVerseIndex = 0;
                state.isPlayingQari = true; // Mulai dengan qari

                renderVerses();
                resetPlayback();
                
                if (verses.length > 0) {
                    elements.statusText.textContent = 
                        `Surah ${surah.name} dimuat. ${verses.length} ayat tersedia.`;
                } else {
                    elements.statusText.textContent = 
                        `Data untuk surah ${surah.name} belum tersedia.`;
                }

            } catch (error) {
                console.error('Error in loadSurah:', error);
                elements.statusText.textContent = error.message;
                elements.quranText.innerHTML = 
                    `<div class="error">${error.message}</div>`;
            }
        }

        function renderVerses() {
            if (!state.currentVerses.length) {
                elements.quranText.innerHTML = '<div class="loading">Tidak ada data ayat</div>';
                return;
            }

            const versesHTML = state.currentVerses.map((verse, index) => `
                <div class="verse" id="verse-${index}">
                    <div class="arabic">${verse.arabic} <span class="verse-number">${verse.number}</span></div>
                    <div class="translation">${verse.translation}</div>
                </div>
            `).join('');
            
            elements.quranText.innerHTML = versesHTML;
        }

        // FUNGSI UTAMA PLAYBACK YANG BENAR
        function playCurrent() {
            if (!state.currentVerses.length || state.currentVerseIndex >= state.currentVerses.length) {
                stopPlayback();
                return;
            }
            
            const verse = state.currentVerses[state.currentVerseIndex];
            
            updateVerseHighlight();
            updateProgress();
            
            if (state.isPlayingQari) {
                // PLAY QARI (Audio Asli)
                playQariAudio(verse);
            } else {
                // PLAY TERJEMAHAN (TTS)
                playTranslationTTS(verse);
            }
        }

        function playQariAudio(verse) {
            elements.statusText.textContent = 
                `Memutar ayat ${verse.number} - Qari ${state.currentSurah.name}`;

            // Bangun URL audio qari
            const audioUrl = `${API_CONFIG.quranApi.audioBaseUrl}/${state.currentQari}/${verse.number}.mp3`;
            
            // Play audio qari
            if (state.audioElement) {
                state.audioElement.pause();
                state.audioElement = null;
            }
            
            state.audioElement = new Audio(audioUrl);
            state.audioElement.preload = 'auto';
            
            state.audioElement.oncanplaythrough = () => {
                state.audioElement.play().catch(e => {
                    console.error('Error playing qari audio:', e);
                    elements.statusText.textContent = 'Error memutar audio qari.';
                    // Skip ke terjemahan jika error
                    setTimeout(() => playNextSegment(), 1000);
                });
            };
            
            state.audioElement.onplay = () => {
                state.isPlaying = true;
                updateControls();
            };
            
            state.audioElement.ontimeupdate = updateProgress;
            
            state.audioElement.onended = () => {
                // Setelah qari selesai, switch ke terjemahan
                state.isPlayingQari = false;
                if (state.autoNext) {
                    playNextSegment();
                } else {
                    elements.statusText.textContent = `Selesai ayat ${verse.number} (Qari)`;
                    state.isPlaying = false;
                    updateControls();
                }
            };
            
            state.audioElement.onerror = (e) => {
                console.error('Qari audio error:', e);
                elements.statusText.textContent = 'Error memutar audio qari. Lanjut ke terjemahan...';
                state.isPlayingQari = false;
                setTimeout(() => playNextSegment(), 1000);
            };
        }

        function playTranslationTTS(verse) {
            elements.statusText.textContent = 
                `Memutar terjemahan ayat ${verse.number} - ${state.currentSurah.name}`;

            if (!state.synthesis) {
                elements.statusText.textContent = 'TTS tidak didukung browser. Lanjut ke ayat berikutnya.';
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                playNextSegment();
                return;
            }

            // Hentikan TTS sebelumnya
            state.synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(verse.translation);
            utterance.lang = 'id-ID';
            utterance.rate = state.voiceSpeed;
            utterance.pitch = 1.0;
            utterance.volume = 1;

            // Cari voice Indonesia
            const voices = state.synthesis.getVoices();
            const indonesianVoice = voices.find(voice => 
                voice.lang.includes('id') || voice.lang.includes('ID')
            );
            
            if (indonesianVoice) {
                utterance.voice = indonesianVoice;
            }

            utterance.onstart = () => {
                // Tandai sedang play terjemahan
                const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
                if (currentVerse) {
                    currentVerse.classList.add('playing-translation');
                }
            };

            utterance.onend = () => {
                // Hapus tanda playing translation
                const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
                if (currentVerse) {
                    currentVerse.classList.remove('playing-translation');
                }
                
                // Setelah terjemahan selesai, switch back ke qari dan lanjut ke ayat berikutnya
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                
                if (state.autoNext) {
                    playNextSegment();
                } else {
                    elements.statusText.textContent = `Selesai terjemahan ayat ${verse.number}`;
                    state.isPlaying = false;
                    updateControls();
                }
            };

            utterance.onerror = (event) => {
                console.error('TTS Error:', event);
                const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
                if (currentVerse) {
                    currentVerse.classList.remove('playing-translation');
                }
                
                // Skip ke ayat berikutnya jika TTS error
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                if (state.autoNext) {
                    playNextSegment();
                }
            };

            state.synthesis.speak(utterance);
        }

        function playNextSegment() {
            if (state.currentVerseIndex < state.currentVerses.length) {
                playCurrent();
            } else {
                elements.statusText.textContent = `Selesai memutar Surah ${state.currentSurah.name}`;
                stopPlayback();
            }
        }

        function updateProgress() {
            if (state.audioElement && state.audioElement.duration && state.isPlayingQari) {
                const progress = (state.audioElement.currentTime / state.audioElement.duration) * 100;
                elements.progressBar.style.width = `${progress}%`;
            } else {
                elements.progressBar.style.width = '0%';
            }
        }

        function updateVerseHighlight() {
            document.querySelectorAll('.verse').forEach(verse => {
                verse.classList.remove('active', 'playing-translation');
            });
            
            const currentVerse = document.getElementById(`verse-${state.currentVerseIndex}`);
            if (currentVerse) {
                if (state.isPlayingQari) {
                    currentVerse.classList.add('active');
                } else {
                    currentVerse.classList.add('playing-translation');
                }
            }
        }

        function startPlayback() {
            if (!state.currentVerses.length) {
                elements.statusText.textContent = "Tidak ada data ayat yang dimuat";
                return;
            }
            
            resetPlayback();
            state.isPlaying = true;
            state.isPaused = false;
            state.isPlayingQari = true; // Mulai dengan qari
            state.currentVerseIndex = 0;
            updateControls();
            playCurrent();
        }

        function pausePlayback() {
            if (state.isPlayingQari && state.audioElement && !state.audioElement.paused) {
                state.audioElement.pause();
            } else if (!state.isPlayingQari && state.synthesis && state.synthesis.speaking) {
                state.synthesis.pause();
            }
            state.isPaused = true;
            updateControls();
            elements.statusText.textContent = "Dijeda";
        }

        function resumePlayback() {
            if (state.isPlayingQari && state.audioElement && state.audioElement.paused) {
                state.audioElement.play();
            } else if (!state.isPlayingQari && state.synthesis && state.synthesis.paused) {
                state.synthesis.resume();
            }
            state.isPaused = false;
            updateControls();
            elements.statusText.textContent = `Melanjutkan ${state.isPlayingQari ? 'Qari' : 'Terjemahan'} ayat ${state.currentVerseIndex + 1}`;
        }

        function stopPlayback() {
            if (state.audioElement) {
                state.audioElement.pause();
                state.audioElement = null;
            }
            if (state.synthesis) {
                state.synthesis.cancel();
            }
            
            state.isPlaying = false;
            state.isPaused = false;
            state.isPlayingQari = true;
            updateControls();
            
            document.querySelectorAll('.verse').forEach(verse => {
                verse.classList.remove('active', 'playing-translation');
            });
            
            elements.progressBar.style.width = '0%';
            elements.statusText.textContent = "Playback dihentikan";
        }

        function resetPlayback() {
            stopPlayback();
            state.currentVerseIndex = 0;
            state.isPlayingQari = true;
        }

        function skipToNext() {
            if (state.isPlaying) {
                if (state.isPlayingQari && state.audioElement) {
                    state.audioElement.pause();
                } else if (!state.isPlayingQari && state.synthesis) {
                    state.synthesis.cancel();
                }
                
                // Langsung skip ke ayat berikutnya (mulai dengan qari)
                state.isPlayingQari = true;
                state.currentVerseIndex++;
                playNextSegment();
            }
        }

        function updateControls() {
            const hasData = state.currentVerses.length > 0;
            
            elements.playBtn.disabled = !hasData || (state.isPlaying && !state.isPaused);
            elements.pauseBtn.disabled = !hasData || !state.isPlaying || state.isPaused;
            elements.stopBtn.disabled = !hasData || !state.isPlaying;
            elements.nextBtn.disabled = !hasData || !state.isPlaying || state.currentVerseIndex >= state.currentVerses.length - 1;
            
            elements.playBtn.textContent = state.isPaused ? "▶ Lanjutkan" : "▶ Mulai Auto-Play";
        }

        // ==================== EVENT HANDLERS ====================

        elements.surahSelect.addEventListener('change', (e) => {
            loadSurah(parseInt(e.target.value));
        });

        elements.qariSelect.addEventListener('change', (e) => {
            state.currentQari = e.target.value;
        });

        elements.playBtn.addEventListener('click', () => {
            if (state.isPaused) {
                resumePlayback();
            } else {
                startPlayback();
            }
        });

        elements.pauseBtn.addEventListener('click', pausePlayback);
        elements.stopBtn.addEventListener('click', stopPlayback);
        elements.nextBtn.addEventListener('click', skipToNext);
        
        elements.autoNextBtn.addEventListener('click', () => {
            state.autoNext = !state.autoNext;
            elements.autoNextBtn.textContent = `Auto Next: ${state.autoNext ? 'ON' : 'OFF'}`;
            elements.autoNextBtn.classList.toggle('active', state.autoNext);
        });

        elements.voiceSpeedBtn.addEventListener('click', () => {
            const speeds = [0.8, 1.0, 1.2, 1.5];
            const currentIndex = speeds.indexOf(state.voiceSpeed);
            const nextIndex = (currentIndex + 1) % speeds.length;
            state.voiceSpeed = speeds[nextIndex];
            
            const labels = ['Lambat', 'Normal', 'Cepat', 'Sangat Cepat'];
            elements.voiceSpeedBtn.textContent = `Kecepatan: ${labels[nextIndex]}`;
        });

        // ==================== INITIALIZATION ====================

        window.addEventListener('load', () => {
            // Load voices untuk TTS
            if (state.synthesis) {
                state.synthesis.onvoiceschanged = () => {
                    console.log('Voices loaded:', state.synthesis.getVoices());
                };
            }

            // Load surah pertama secara default
            loadSurah(1);
        });

        // Handle visibility change - pause when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && state.isPlaying && !state.isPaused) {
                pausePlayback();
            }
        });
    </script>
</body>
</html>
